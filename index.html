
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nghe và Viết Chính Tả</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Nunito', sans-serif;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior: none;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-8px); }
        75% { transform: translateX(8px); }
      }
      .animate-shake {
        animation: shake 0.5s;
      }
      .btn-primary { 
        padding: 0.75rem 1.75rem; 
        color: white; 
        font-weight: bold; 
        border-radius: 0.75rem; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        transition: all 0.3s ease;
        touch-action: manipulation;
      } 
      .btn-primary:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
      } 
      .btn-primary:disabled { 
        background-color: #bdbdbd !important;
        cursor: not-allowed; 
        transform: none; 
        box-shadow: none; 
      }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const GameState = {
        START: 'start',
        TOPIC_SELECTION: 'topicSelection',
        GAME: 'game',
        CONGRATS: 'congrats',
        REVIEW_ERRORS: 'review',
    };
    
    const allSentences = [
        { en: "In Britain, students have to wear uniforms when they go to school.", vi: "Ở Anh, học sinh phải mặc đồng phục khi đến trường.", emoji: "🇬🇧" },
        { en: "The teacher said that we should work harder on our pronunciation.", vi: "Giáo viên nói rằng chúng ta nên chăm chỉ hơn về phát âm.", emoji: "🗣️" },
        { en: "His mother told him not to leave the door unlocked.", vi: "Mẹ anh ấy dặn anh ấy không được để cửa mở khóa.", emoji: "🚪" },
        { en: "Long time ago Levis made his pants with blue cotton cloth called 'denim'.", vi: "Ngày xưa, Levis đã làm quần bằng vải cotton xanh gọi là 'denim'.", emoji: "👖" },
        { en: "The chair is beside the door.", vi: "Cái ghế ở cạnh cửa.", emoji: "🪑" },
        { en: "I couldn't make coffee for everybody. There weren't enough cups.", vi: "Tôi không thể pha cà phê cho mọi người. Không có đủ cốc.", emoji: "☕" },
        { en: "I'm studying very hard at the moment because I want to pass the exam.", vi: "Tôi đang học rất chăm chỉ vì tôi muốn vượt qua kỳ thi.", emoji: "📚" },
        { en: "In order to be highly paid, they work much harder.", vi: "Để được trả lương cao, họ làm việc chăm chỉ hơn nhiều.", emoji: "💰" },
        { en: "Smoking should be prohibited in public.", vi: "Hút thuốc nên bị cấm ở nơi công cộng.", emoji: "🚭" },
        { en: "Where does Mr. Brown work?", vi: "Ông Brown làm việc ở đâu?", emoji: "👨‍💼" },
        { en: "You are responsible to her for your serious mistakes.", vi: "Bạn phải chịu trách nhiệm với cô ấy về những lỗi lầm nghiêm trọng của mình.", emoji: "😟" },
        { en: "How often do they go camping?", vi: "Họ có thường đi cắm trại không?", emoji: "🏕️" },
        { en: "The climate is getting hotter and hotter.", vi: "Khí hậu đang ngày càng nóng lên.", emoji: "🌡️" },
        { en: "My sister isn't very keen on computer games.", vi: "Chị gái tôi không hứng thú lắm với trò chơi máy tính.", emoji: "🎮" },
        { en: "He thinks that chatting on the Internet is a waste of time.", vi: "Anh ấy nghĩ rằng tán gẫu trên Internet là một sự lãng phí thời gian.", emoji: "💻" },
        { en: "He bought his house with his own money.", vi: "Anh ấy đã mua nhà bằng tiền của mình.", emoji: "🏠" },
        { en: "They marked the occasion with an open-air concert.", vi: "Họ đã kỷ niệm sự kiện bằng một buổi hòa nhạc ngoài trời.", emoji: "🎤" },
        { en: "Study hard or you'll fail the exam.", vi: "Học hành chăm chỉ nếu không bạn sẽ trượt kỳ thi.", emoji: "✍️" },
        { en: "Many people think that students have an easy life.", vi: "Nhiều người nghĩ rằng sinh viên có một cuộc sống dễ dàng.", emoji: "🧑‍🎓" },
        { en: "Our post is delivered daily, except on Sunday.", vi: "Bưu phẩm của chúng tôi được giao hàng ngày, trừ Chủ nhật.", emoji: "📮" },
        { en: "Most paper is made from wood.", vi: "Hầu hết giấy được làm từ gỗ.", emoji: "🌳" },
        { en: "On the other hand, there are some serious disadvantages.", vi: "Mặt khác, có một số nhược điểm nghiêm trọng.", emoji: "🤔" },
        { en: "A grocery store is a place where people can buy food and small things.", vi: "Cửa hàng tạp hóa là nơi mọi người có thể mua thực phẩm và những thứ nhỏ nhặt.", emoji: "🛒" },
        { en: "You have to pay a deposit if you want to use the motorbike.", vi: "Bạn phải trả tiền đặt cọc nếu muốn sử dụng xe máy.", emoji: "🛵" },
        { en: "Peter used to write to me until last year. Now he sends me e-mail.", vi: "Peter thường viết thư cho tôi cho đến năm ngoái. Bây giờ anh ấy gửi email cho tôi.", emoji: "📧" },
        { en: "Did your flatmate use to clean the house?", vi: "Bạn cùng phòng của bạn có thường dọn dẹp nhà cửa không?", emoji: "🧹" },
        { en: "These girls are not old enough to get married.", vi: "Những cô gái này chưa đủ tuổi để kết hôn.", emoji: "💍" },
        { en: "He said 'Hello' in a most friendly way.", vi: "Anh ấy nói 'Xin chào' một cách rất thân thiện.", emoji: "👋" },
        { en: "Binet wants to learn about auto mechanics.", vi: "Binet muốn học về cơ khí ô tô.", emoji: "🔧" },
        { en: "The girl helping children in her free time is my friend.", vi: "Cô gái giúp đỡ trẻ em trong thời gian rảnh là bạn của tôi.", emoji: "👧" },
        { en: "I was drying the dishes when I dropped the plate.", vi: "Tôi đang lau bát đĩa thì làm rơi cái đĩa.", emoji: "🍽️" },
        { en: "Limestone is a type of white or gray stone containing calcium, used for building and making cement.", vi: "Đá vôi là một loại đá màu trắng hoặc xám chứa canxi, được sử dụng để xây dựng và làm xi măng.", emoji: "🪨" },
        { en: "Milk bottles can be reused after being cleaned.", vi: "Chai sữa có thể được tái sử dụng sau khi được làm sạch.", emoji: "♻️" },
        { en: "She arrived early in order to get a good seat.", vi: "Cô ấy đã đến sớm để có được một chỗ ngồi tốt.", emoji: "🪑" },
        { en: "The journey was quite different from what I thought it would be.", vi: "Chuyến đi khá khác so với những gì tôi nghĩ.", emoji: "🗺️" },
        { en: "You can answer these questions by mail.", vi: "Bạn có thể trả lời những câu hỏi này qua thư.", emoji: "✉️" },
        { en: "Thank you for waking me up. I was having a nightmare!", vi: "Cảm ơn bạn đã đánh thức tôi. Tôi đã gặp ác mộng!", emoji: "😱" },
        { en: "The secretary will arrange for you to visit our factory next week.", vi: "Thư ký sẽ sắp xếp cho bạn đến thăm nhà máy của chúng tôi vào tuần tới.", emoji: "🏭" },
        { en: "He locked the door so that nobody could disturb him.", vi: "Anh ấy đã khóa cửa để không ai có thể làm phiền anh ấy.", emoji: "🔒" },
        { en: "The ASEAN was established in 1967.", vi: "ASEAN được thành lập vào năm 1967.", emoji: "🤝" },
        { en: "It is a four-hour drive from Thanh Hoa to Hanoi.", vi: "Mất bốn giờ lái xe từ Thanh Hóa đến Hà Nội.", emoji: "🚗" },
        { en: "I bought lace curtains for my bedroom window.", vi: "Tôi đã mua rèm ren cho cửa sổ phòng ngủ của mình.", emoji: "🪟" },
        { en: "They fly kites when they have free time.", vi: "Họ thả diều khi có thời gian rảnh.", emoji: "🪁" },
        { en: "They kept me waiting for twenty minutes.", vi: "Họ bắt tôi đợi hai mươi phút.", emoji: "⏳" },
        { en: "When I met them in the streets yesterday, they were going to the cinema.", vi: "Khi tôi gặp họ trên đường phố hôm qua, họ đang đi đến rạp chiếu phim.", emoji: "🎬" },
        { en: "My sister loves to watch the stars at night.", vi: "Chị gái tôi thích ngắm sao vào ban đêm.", emoji: "⭐" },
        { en: "Lying on the sofa, you can turn on or turn off your TV by using the remote control.", vi: "Nằm trên ghế sofa, bạn có thể bật hoặc tắt TV bằng điều khiển từ xa.", emoji: "🛋️" },
        { en: "Agriculture may cause environmental problems.", vi: "Nông nghiệp có thể gây ra các vấn đề về môi trường.", emoji: "🌾" },
        { en: "One of the important skills in learning a language is writing.", vi: "Một trong những kỹ năng quan trọng trong việc học một ngôn ngữ là viết.", emoji: "✍️" },
        { en: "The victim was given first-aid before he was taken to hospital.", vi: "Nạn nhân đã được sơ cứu trước khi được đưa đến bệnh viện.", emoji: "🚑" },
        { en: "The students were talking noisily when the teacher came in.", vi: "Các học sinh đang nói chuyện ồn ào khi giáo viên bước vào.", emoji: "🤫" },
        { en: "Phong doesn't like English. He is very bad at it.", vi: "Phong không thích tiếng Anh. Anh ấy rất tệ môn đó.", emoji: "🇬🇧" },
        { en: "The footballer scored six goals, so his team won the game.", vi: "Cầu thủ bóng đá đã ghi sáu bàn, vì vậy đội của anh ấy đã thắng trận đấu.", emoji: "⚽" },
        { en: "They have known each other for a long time.", vi: "Họ đã biết nhau từ lâu.", emoji: "🧑‍🤝‍🧑" },
        { en: "Arthur apologized for hurting her feeling.", vi: "Arthur đã xin lỗi vì đã làm tổn thương cảm xúc của cô ấy.", emoji: "😔" },
        { en: "Put down your gun and put up your hands.", vi: "Đặt súng xuống và giơ tay lên.", emoji: "🙌" },
        { en: "To obtain the best result, mix the powder with warm water.", vi: "Để có kết quả tốt nhất, hãy trộn bột với nước ấm.", emoji: "🧪" },
        { en: "If I had a lot of money, I would buy a car.", vi: "Nếu tôi có nhiều tiền, tôi sẽ mua một chiếc ô tô.", emoji: "💰" },
        { en: "People didn't talk on the phone one hundred years ago.", vi: "Mọi người không nói chuyện trên điện thoại một trăm năm trước.", emoji: "☎️" },
        { en: "Jane and Jack stood in front of the mirror and looked at themselves.", vi: "Jane và Jack đứng trước gương và nhìn mình.", emoji: "🪞" },
        { en: "After the flood, people in this province have to face up to famine.", vi: "Sau trận lụt, người dân ở tỉnh này phải đối mặt với nạn đói.", emoji: "🌊" },
        { en: "This pen costs twice as much as the other one.", vi: "Cây bút này đắt gấp đôi cây bút kia.", emoji: "🖊️" },
        { en: "He is delighted that you have paid attention to recycling.", vi: "Anh ấy rất vui vì bạn đã quan tâm đến việc tái chế.", emoji: "♻️" },
        { en: "We are taking our evening walk at the moment.", vi: "Chúng tôi đang đi dạo buổi tối vào lúc này.", emoji: "🚶" },
        { en: "He asked me where I would go the next day.", vi: "Anh ấy hỏi tôi sẽ đi đâu vào ngày hôm sau.", emoji: "❓" },
        { en: "They work hard so that they might be well prepared for the examination.", vi: "Họ làm việc chăm chỉ để có thể chuẩn bị tốt cho kỳ thi.", emoji: "✍️" },
        { en: "The car alarm woke me up at 6:00 yesterday morning.", vi: "Chuông báo động ô tô đã đánh thức tôi lúc 6:00 sáng hôm qua.", emoji: "⏰" },
        { en: "Mary is interested in marine life so she's visiting the oceanic institute in Nha Trang.", vi: "Mary quan tâm đến sinh vật biển nên cô ấy đang đến thăm viện hải dương học ở Nha Trang.", emoji: "🐠" },
        { en: "It took the old woman an hour to walk to the provision shop and return.", vi: "Bà lão mất một giờ để đi bộ đến cửa hàng thực phẩm và quay lại.", emoji: "👵" },
        { en: "The 20th century is considered to be the century of inventions with TV, computer and etc.", vi: "Thế kỷ 20 được coi là thế kỷ của các phát minh với TV, máy tính, v.v.", emoji: "💡" },
        { en: "Would you like to have a cup of coffee?", vi: "Bạn có muốn uống một tách cà phê không?", emoji: "☕" },
        { en: "Every week, there are two flights from Ha Noi to Nha Trang.", vi: "Mỗi tuần có hai chuyến bay từ Hà Nội đến Nha Trang.", emoji: "✈️" },
        { en: "Her full name's Sarah Johnson.", vi: "Tên đầy đủ của cô ấy là Sarah Johnson.", emoji: "🧑" },
        { en: "The factory workers work from seven in the morning until five in the afternoon.", vi: "Các công nhân nhà máy làm việc từ bảy giờ sáng đến năm giờ chiều.", emoji: "🏭" },
        { en: "The storm prevented the climbers from continuing their adventure.", vi: "Cơn bão đã ngăn cản những người leo núi tiếp tục cuộc phiêu lưu của họ.", emoji: "⛈️" },
        { en: "Supplying COVID-19 vaccines is not enough.", vi: "Cung cấp vắc-xin COVID-19 là không đủ.", emoji: "💉" },
        { en: "My brother has a car but he does not use it very often.", vi: "Anh trai tôi có một chiếc ô tô nhưng anh ấy không sử dụng nó thường xuyên.", emoji: "🚗" },
        { en: "Before accepting your job offer, can you tell me some more about the company?", vi: "Trước khi chấp nhận lời mời làm việc của bạn, bạn có thể cho tôi biết thêm về công ty được không?", emoji: "🏢" },
        { en: "What do you like best about your school?", vi: "Bạn thích điều gì nhất ở trường của mình?", emoji: "🏫" },
        { en: "We saw a lot of women planting rice in the rice fields.", vi: "Chúng tôi đã thấy rất nhiều phụ nữ cấy lúa trên những cánh đồng lúa.", emoji: "🌾" },
        { en: "Unfortunately, our flight was delayed for 2 hours, so we were late for the last train.", vi: "Thật không may, chuyến bay của chúng tôi đã bị hoãn 2 giờ, vì vậy chúng tôi đã trễ chuyến tàu cuối cùng.", emoji: "🚆" },
        { en: "What a nuisance! I hope we won't meet him again.", vi: "Thật là phiền phức! Tôi hy vọng chúng ta sẽ không gặp lại anh ta.", emoji: "😤" },
        { en: "When I entered his house, he was cooking.", vi: "Khi tôi vào nhà anh ấy, anh ấy đang nấu ăn.", emoji: "🍳" },
        { en: "They spent a lot of money on food and clothes.", vi: "Họ đã chi rất nhiều tiền cho thực phẩm và quần áo.", emoji: "🛍️" },
        { en: "How can we remember all these vocabulary items?", vi: "Làm thế nào chúng ta có thể nhớ tất cả các mục từ vựng này?", emoji: "🧠" },
        { en: "I wonder if he will ever return home after going to Paris.", vi: "Tôi tự hỏi liệu anh ấy có bao giờ trở về nhà sau khi đến Paris không.", emoji: "🇫🇷" },
        { en: "The Panama Canal is in South America.", vi: "Kênh đào Panama ở Nam Mỹ.", emoji: "🌎" },
        { en: "My grandmother is very religious. She goes to pagoda every week.", vi: "Bà tôi rất sùng đạo. Bà đi chùa mỗi tuần.", emoji: "👵" },
        { en: "The company will invest 2 million dollars to modernize its factories.", vi: "Công ty sẽ đầu tư 2 triệu đô la để hiện đại hóa các nhà máy của mình.", emoji: "🏭" },
        { en: "It is better for schoolgirls to wear trousers and blouses when they are at school.", vi: "Tốt hơn cho nữ sinh khi mặc quần và áo sơ mi khi ở trường.", emoji: "👚" },
        { en: "The boss told him to get out of the room.", vi: "Sếp bảo anh ta ra khỏi phòng.", emoji: "😠" },
        { en: "Sooner or later a satellite will be destroyed by a large piece of rubbish.", vi: "Sớm hay muộn một vệ tinh sẽ bị phá hủy bởi một mảnh rác lớn.", emoji: "🛰️" },
        { en: "The children are playing happily in the schoolyard.", vi: "Các em đang chơi vui vẻ trong sân trường.", emoji: "🤸" },
        { en: "There aren't any buses in the streets because the drivers have gone on strike.", vi: "Không có xe buýt nào trên đường phố vì các tài xế đã đình công.", emoji: "🚌" },
        { en: "Jack told me that he was enjoying his new class.", vi: "Jack nói với tôi rằng anh ấy đang thích lớp học mới của mình.", emoji: "🧑‍🏫" },
        { en: "The teacher was ill last week.", vi: "Giáo viên bị ốm vào tuần trước.", emoji: "🤒" },
        { en: "Is Facebook a dangerous addiction or just harmless fun?", vi: "Facebook là một chứng nghiện nguy hiểm hay chỉ là một niềm vui vô hại?", emoji: "📱" },
        { en: "We use chalk to write things on the blackboard.", vi: "Chúng tôi dùng phấn để viết lên bảng đen.", emoji: "✍️" },
        { en: "If the work is finished by lunchtime, you can go home.", vi: "Nếu công việc được hoàn thành trước giờ ăn trưa, bạn có thể về nhà.", emoji: "🕛" },
        { en: "It was very uncomfortable to sit in one place for so long.", vi: "Ngồi một chỗ quá lâu thật không thoải mái.", emoji: "🧘" },
        { en: "Sorry, I am late because I got stuck in the traffic jam.", vi: "Xin lỗi, tôi đến muộn vì bị kẹt xe.", emoji: "🚗" },
        { en: "Mr. James was painting a picture when I came to meet him.", vi: "Ông James đang vẽ một bức tranh khi tôi đến gặp ông.", emoji: "🎨" },
        { en: "She is flying to Hanoi next Monday.", vi: "Cô ấy sẽ bay đến Hà Nội vào thứ Hai tới.", emoji: "✈️" },
        { en: "His mother asked him to tidy up his room as it was dirty.", vi: "Mẹ anh ấy yêu cầu anh ấy dọn dẹp phòng của mình vì nó bẩn.", emoji: "🧹" },
        { en: "They are going to see the temple tomorrow.", vi: "Họ sẽ đi xem ngôi đền vào ngày mai.", emoji: "🏛️" },
        { en: "He has written four novels so far.", vi: "Anh ấy đã viết bốn cuốn tiểu thuyết cho đến nay.", emoji: "📚" },
        { en: "Remember to wear your warm clothes when it's cold.", vi: "Hãy nhớ mặc quần áo ấm khi trời lạnh.", emoji: "🧥" },
        { en: "It'll only take me a few minutes and I'll be back very soon.", vi: "Sẽ chỉ mất vài phút thôi và tôi sẽ quay lại rất sớm.", emoji: "⏳" },
        { en: "At last, after trying three times, he passed the examination.", vi: "Cuối cùng, sau khi thử ba lần, anh ấy đã vượt qua kỳ thi.", emoji: "🎉" },
        { en: "You ought to report to the police if you see a robbery.", vi: "Bạn nên báo cảnh sát nếu bạn thấy một vụ cướp.", emoji: "🚓" },
        { en: "There was a scary big storm on Christmas Day.", vi: "Có một cơn bão lớn đáng sợ vào ngày Giáng sinh.", emoji: "⛈️" },
        { en: "Her good diet keeps her healthy.", vi: "Chế độ ăn uống tốt của cô ấy giúp cô ấy khỏe mạnh.", emoji: "🥗" },
        { en: "The cat is lying leisurely in the morning sunshine.", vi: "Con mèo đang nằm thảnh thơi trong nắng sớm.", emoji: "🐈" },
        { en: "Over 50000 people in Ethiopia have died of starvation in the past month.", vi: "Hơn 50000 người ở Ethiopia đã chết vì đói trong tháng qua.", emoji: "😔" },
        { en: "I arrived home at ten fifteen last night.", vi: "Tôi về nhà lúc mười giờ mười lăm tối qua.", emoji: "🕙" },
        { en: "He failed the examination. He didn't study hard enough.", vi: "Anh ấy đã trượt kỳ thi. Anh ấy đã không học đủ chăm chỉ.", emoji: "😞" },
        { en: "My car was repaired yesterday.", vi: "Xe của tôi đã được sửa chữa ngày hôm qua.", emoji: "🔧" },
        { en: "All the subjects were taught by one teacher.", vi: "Tất cả các môn học đều do một giáo viên giảng dạy.", emoji: "👨‍🏫" },
        { en: "This is the first time I have visited a famous place in Hanoi.", vi: "Đây là lần đầu tiên tôi đến thăm một địa điểm nổi tiếng ở Hà Nội.", emoji: "🇻🇳" },
        { en: "Nobody wants to work with him because he is always neglecting his duties.", vi: "Không ai muốn làm việc với anh ta vì anh ta luôn bỏ bê nhiệm vụ của mình.", emoji: "😠" },
        { en: "Your sister likes watching detective films, doesn't she?", vi: "Chị gái bạn thích xem phim trinh thám, phải không?", emoji: "🕵️" },
        { en: "The film was not interesting enough for me to watch.", vi: "Bộ phim không đủ thú vị để tôi xem.", emoji: "🎬" },
        { en: "My grandmother prefers wearing the traditional clothing to the modern clothing.", vi: "Bà tôi thích mặc quần áo truyền thống hơn quần áo hiện đại.", emoji: "👵" },
        { en: "By whom was this story written?", vi: "Câu chuyện này được viết bởi ai?", emoji: "✍️" },
        { en: "I went out with some friends on Saturday.", vi: "Tôi đã đi chơi với một vài người bạn vào thứ Bảy.", emoji: "🧑‍🤝‍🧑" },
        { en: "If I were you, I would call and apologize.", vi: "Nếu tôi là bạn, tôi sẽ gọi và xin lỗi.", emoji: "📞" },
        { en: "She went to market without buying anything.", vi: "Cô ấy đi chợ mà không mua bất cứ thứ gì.", emoji: "🛒" },
        { en: "Someone is knocking at the door.", vi: "Có ai đó đang gõ cửa.", emoji: "🚪" },
        { en: "I need a hair dresser. I haven't been to the barber's recently.", vi: "Tôi cần một thợ làm tóc. Gần đây tôi chưa đến tiệm cắt tóc.", emoji: "💇" },
        { en: "Sharp knives are actually safer to use than dull ones.", vi: "Dao sắc thực sự an toàn hơn dao cùn.", emoji: "🔪" },
        { en: "Don't you believe in equality between men and women?", vi: "Bạn không tin vào sự bình đẳng giữa nam và nữ sao?", emoji: "⚖️" },
        { en: "Smoking is unhealthy but lots of people find it difficult to stop.", vi: "Hút thuốc không tốt cho sức khỏe nhưng rất nhiều người cảm thấy khó bỏ.", emoji: "🚭" },
        { en: "In the world, tons of used papers are thrown away every day.", vi: "Trên thế giới, hàng tấn giấy đã qua sử dụng bị vứt đi mỗi ngày.", emoji: "🗑️" },
        { en: "As a sensible man, Henry always looks calm and makes a wise decision.", vi: "Là một người đàn ông khôn ngoan, Henry luôn trông bình tĩnh và đưa ra quyết định sáng suốt.", emoji: "🧠" },
        { en: "In industry, most glass is manufactured.", vi: "Trong công nghiệp, hầu hết thủy tinh được sản xuất.", emoji: "🏭" },
        { en: "It's very kind of you to help me.", vi: "Bạn thật tốt bụng khi giúp tôi.", emoji: "😊" },
        { en: "Hyde Park is a very large park in central London.", vi: "Hyde Park là một công viên rất lớn ở trung tâm London.", emoji: "🌳" },
        { en: "He wants to design a mobile app that makes education fun and easy.", vi: "Anh ấy muốn thiết kế một ứng dụng di động giúp việc học trở nên thú vị và dễ dàng.", emoji: "📱" },
        { en: "Medical facilities are more easily accessible than ever before.", vi: "Các cơ sở y tế dễ tiếp cận hơn bao giờ hết.", emoji: "🏥" },
        { en: "Our teacher asked us what we were most worried about.", vi: "Giáo viên hỏi chúng tôi lo lắng nhất về điều gì.", emoji: "😟" },
        { en: "Mai broke the glass because of her carelessness.", vi: "Mai đã làm vỡ kính vì sự bất cẩn của mình.", emoji: "💥" },
        { en: "Bill Gates is a very important person in the computer industry.", vi: "Bill Gates là một người rất quan trọng trong ngành công nghiệp máy tính.", emoji: "💻" },
        { en: "I catch the bus near my house and then walk from the bus stop to school.", vi: "Tôi bắt xe buýt gần nhà và sau đó đi bộ từ trạm xe buýt đến trường.", emoji: "🚌" },
        { en: "Our environment is becoming more and more polluted.", vi: "Môi trường của chúng ta đang ngày càng bị ô nhiễm.", emoji: "🏭" },
        { en: "Yellowstone is the United States' most famous national park.", vi: "Yellowstone là công viên quốc gia nổi tiếng nhất của Hoa Kỳ.", emoji: "🏞️" },
        { en: "Columbus discovered America in the 15th century.", vi: "Columbus đã khám phá ra châu Mỹ vào thế kỷ 15.", emoji: "🌎" },
        { en: "Can you give me a ride?", vi: "Bạn có thể cho tôi đi nhờ được không?", emoji: "🚗" },
        { en: "What is the boy with black hair doing?", vi: "Cậu bé tóc đen đang làm gì vậy?", emoji: "👦" },
        { en: "Read the user's manual carefully.", vi: "Đọc kỹ hướng dẫn sử dụng.", emoji: "📖" },
        { en: "He set very difficult standards for himself.", vi: "Anh ấy đặt ra những tiêu chuẩn rất khó khăn cho bản thân.", emoji: "🎯" },
        { en: "The cold 'cures' don't cure a cold, but they relieve the symptoms.", vi: "Các 'phương pháp chữa' cảm lạnh không chữa khỏi cảm lạnh, nhưng chúng làm giảm các triệu chứng.", emoji: "💊" },
        { en: "Add sugar, water and flour to the beaten eggs and stir the mixture well.", vi: "Thêm đường, nước và bột vào trứng đã đánh và khuấy đều hỗn hợp.", emoji: "🥚" },
        { en: "My little daughter is looking at herself in the mirror.", vi: "Con gái nhỏ của tôi đang soi gương.", emoji: "🪞" },
        { en: "About 60% of the world's radio stations broadcast in English.", vi: "Khoảng 60% các đài phát thanh trên thế giới phát sóng bằng tiếng Anh.", emoji: "📻" },
        { en: "A gallery is a building or a room where people can go to look at paintings.", vi: "Phòng trưng bày là một tòa nhà hoặc một căn phòng nơi mọi người có thể đến xem tranh.", emoji: "🖼️" },
        { en: "His teacher said that he should do his homework more carefully.", vi: "Giáo viên của anh ấy nói rằng anh ấy nên làm bài tập về nhà cẩn thận hơn.", emoji: "✍️" },
        { en: "I always drive past the post office on my way to work.", vi: "Tôi luôn lái xe qua bưu điện trên đường đi làm.", emoji: "🏤" },
        { en: "I asked if she could speak English.", vi: "Tôi hỏi cô ấy có nói được tiếng Anh không.", emoji: "🗣️" },
        { en: "By learning English, you can get access to the world's development.", vi: "Bằng cách học tiếng Anh, bạn có thể tiếp cận với sự phát triển của thế giới.", emoji: "🌍" },
        { en: "He always avoids meeting me.", vi: "Anh ấy luôn tránh gặp tôi.", emoji: "😒" },
        { en: "We sometimes send our relatives or friends greeting cards on special occasions.", vi: "Chúng tôi thỉnh thoảng gửi thiệp chúc mừng cho họ hàng hoặc bạn bè vào những dịp đặc biệt.", emoji: "💌" },
        { en: "Binh and I didn't go anywhere last weekend.", vi: "Bình và tôi không đi đâu vào cuối tuần trước.", emoji: "🏠" },
        { en: "I have been staying in England for a few weeks now.", vi: "Tôi đã ở Anh được vài tuần rồi.", emoji: "🇬🇧" },
        { en: "It was difficult to arrange a day which was convenient for everyone.", vi: "Thật khó để sắp xếp một ngày thuận tiện cho mọi người.", emoji: "🗓️" },
        { en: "The new radio didn't work, so he took it back to the shop.", vi: "Cái radio mới không hoạt động, vì vậy anh ấy đã mang nó trở lại cửa hàng.", emoji: "📻" },
        { en: "There was so little sugar that I decided not to make a cake.", vi: "Có quá ít đường nên tôi quyết định không làm bánh.", emoji: "🍰" },
        { en: "I ran out of the room when the phone rang.", vi: "Tôi chạy ra khỏi phòng khi điện thoại reo.", emoji: "🏃" },
        { en: "These spoons are made from metal.", vi: "Những chiếc thìa này được làm từ kim loại.", emoji: "🥄" },
        { en: "Dead leaves fall to the ground and decompose very quickly in wet weather.", vi: "Lá chết rơi xuống đất và phân hủy rất nhanh trong thời tiết ẩm ướt.", emoji: "🍂" },
        { en: "Don't talk like that to me!", vi: "Đừng nói chuyện với tôi như vậy!", emoji: "😠" },
        { en: "Here is the photo of my family and let me tell you about us.", vi: "Đây là bức ảnh của gia đình tôi và để tôi kể cho bạn nghe về chúng tôi.", emoji: "👨‍👩‍👧‍👦" },
        { en: "There are only a few hotels in the city so it's hard to find accommodation during the high season.", vi: "Chỉ có một vài khách sạn trong thành phố nên rất khó tìm chỗ ở trong mùa cao điểm.", emoji: "🏨" },
        { en: "The doctor advised Robert to drink more fresh water.", vi: "Bác sĩ khuyên Robert nên uống nhiều nước lọc hơn.", emoji: "💧" },
        { en: "Having the common cold is very unpleasant.", vi: "Bị cảm lạnh thông thường rất khó chịu.", emoji: "🤧" },
        { en: "When the clock strikes 6 a.m., my new day begins again.", vi: "Khi đồng hồ điểm 6 giờ sáng, một ngày mới của tôi lại bắt đầu.", emoji: "🕕" },
        { en: "We can look for information on recycling things in the local library.", vi: "Chúng ta có thể tìm kiếm thông tin về việc tái chế mọi thứ trong thư viện địa phương.", emoji: "♻️" },
        { en: "The 22nd Olympic Games were held in Moscow.", vi: "Thế vận hội Olympic lần thứ 22 được tổ chức tại Moscow.", emoji: "🏆" },
        { en: "My sister is better at cooking than I am.", vi: "Chị gái tôi nấu ăn ngon hơn tôi.", emoji: "🍳" },
        { en: "These kinds of flowers are beautiful enough to be exported to foreign markets.", vi: "Những loại hoa này đủ đẹp để xuất khẩu sang thị trường nước ngoài.", emoji: "💐" },
        { en: "It took me a long time to get used to wearing glasses.", vi: "Tôi mất một thời gian dài để quen với việc đeo kính.", emoji: "👓" },
        { en: "Much of champagne is exported from France to our country this year.", vi: "Phần lớn sâm panh được xuất khẩu từ Pháp sang nước ta trong năm nay.", emoji: "🍾" },
        { en: "Our post is delivered daily, except on Sunday.", vi: "Bưu phẩm của chúng tôi được giao hàng ngày, trừ Chủ nhật.", emoji: "📮" },
        { en: "She used to be fond of pop music but has now lost interest in it.", vi: "Cô ấy từng thích nhạc pop nhưng giờ đã không còn hứng thú nữa.", emoji: "🎶" },
        { en: "The song is about a green frog.", vi: "Bài hát nói về một con ếch xanh.", emoji: "🐸" },
        { en: "We flew over the volcano and saw lava was pouring out.", vi: "Chúng tôi bay qua núi lửa và thấy dung nham đang phun trào.", emoji: "🌋" },
        { en: "Nam often makes other people laugh because he likes telling jokes.", vi: "Nam thường làm người khác cười vì anh ấy thích kể chuyện cười.", emoji: "😂" },
        { en: "He was so tired that he went to bed early.", vi: "Anh ấy quá mệt nên đã đi ngủ sớm.", emoji: "😴" },
        { en: "The weather forecast said it would rain heavily the following day.", vi: "Dự báo thời tiết cho biết trời sẽ mưa to vào ngày hôm sau.", emoji: "🌧️" },
        { en: "He is going to catch a bus to the Imperial Citadel of Thang Long next Sunday.", vi: "Anh ấy sẽ bắt xe buýt đến Hoàng thành Thăng Long vào Chủ nhật tới.", emoji: "🚌" },
        { en: "I'm not sure, but as far as I know he will stay at home on holiday.", vi: "Tôi không chắc, nhưng theo tôi biết thì anh ấy sẽ ở nhà vào kỳ nghỉ.", emoji: "🏠" },
        { en: "My father doesn't smoke cigarettes any more. He gave it up five years ago.", vi: "Bố tôi không hút thuốc lá nữa. Ông đã bỏ thuốc năm năm trước.", emoji: "🚭" },
        { en: "Your application must be typed in 3 copies to hand in for our company.", vi: "Đơn của bạn phải được đánh máy thành 3 bản để nộp cho công ty chúng tôi.", emoji: "📄" },
        { en: "He gives her a novel about a love story.", vi: "Anh ấy tặng cô một cuốn tiểu thuyết về một câu chuyện tình yêu.", emoji: "❤️" },
        { en: "Big Ben is the most famous clock in London.", vi: "Big Ben là chiếc đồng hồ nổi tiếng nhất ở London.", emoji: "🕰️" },
        { en: "You can play whatever games you like in summer holiday.", vi: "Bạn có thể chơi bất cứ trò chơi nào bạn thích trong kỳ nghỉ hè.", emoji: "🎮" },
        { en: "It only takes me about 40 minutes to get to work.", vi: "Tôi chỉ mất khoảng 40 phút để đi làm.", emoji: "⏳" },
        { en: "It is a thirty-minute drive from here to the city center.", vi: "Mất ba mươi phút lái xe từ đây đến trung tâm thành phố.", emoji: "🚗" },
        { en: "If people don't throw trash into the water, it won't be polluted.", vi: "Nếu mọi người không xả rác xuống nước, nó sẽ không bị ô nhiễm.", emoji: "💧" },
        { en: "He used to drive more carefully than he does now.", vi: "Anh ấy từng lái xe cẩn thận hơn bây giờ.", emoji: "🚗" },
        { en: "We arrived on time although the traffic was bad.", vi: "Chúng tôi đã đến đúng giờ mặc dù giao thông rất tệ.", emoji: "⏰" },
        { en: "Jane and Jack stood in front of the mirror and looked at themselves.", vi: "Jane và Jack đứng trước gương và soi mình.", emoji: "🪞" },
        { en: "The professor gave an interesting talk on the global climates.", vi: "Giáo sư đã có một bài nói chuyện thú vị về khí hậu toàn cầu.", emoji: "👨‍🏫" },
        { en: "John should go to Nha Rong Harbor because it is the place where President Ho Chi Minh left Vietnam in 1911.", vi: "John nên đến Bến Nhà Rồng vì đó là nơi Chủ tịch Hồ Chí Minh rời Việt Nam năm 1911.", emoji: "🇻🇳" },
        { en: "The Amazon is one of the longest rivers in the world.", vi: "Amazon là một trong những con sông dài nhất thế giới.", emoji: "🏞️" },
        { en: "In Vietnam, there are more and more families having cable TV.", vi: "Ở Việt Nam ngày càng có nhiều gia đình có truyền hình cáp.", emoji: "📺" },
        { en: "The victim shouldn't drink any wine when he or she has a shock.", vi: "Nạn nhân không nên uống bất kỳ loại rượu nào khi bị sốc.", emoji: "🍷" },
        { en: "Ricky is looking up the gas station on the mobile phone.", vi: "Ricky đang tìm trạm xăng trên điện thoại di động.", emoji: "⛽" },
        { en: "Which day of the week is the School's festival day?", vi: "Ngày hội của trường là thứ mấy trong tuần?", emoji: "🎉" },
        { en: "After the flood, people in this province have to face up to famine.", vi: "Sau trận lụt, người dân tỉnh này phải đối mặt với nạn đói.", emoji: "🌊" },
        { en: "He arrived in England on Thursday afternoon.", vi: "Anh ấy đến Anh vào chiều thứ Năm.", emoji: "🇬🇧" },
        { en: "They have lived in that house for several months.", vi: "Họ đã sống trong ngôi nhà đó được vài tháng.", emoji: "🏠" },
        { en: "Hue is a very tranquil and marvelous city in the central part of Vietnam.", vi: "Huế là một thành phố rất yên tĩnh và kỳ diệu ở miền trung Việt Nam.", emoji: "🏯" },
        { en: "To Huu was a famous Vietnamese poet.", vi: "Tố Hữu là một nhà thơ nổi tiếng của Việt Nam.", emoji: "✍️" },
        { en: "It took the old woman an hour to walk around the lake yesterday.", vi: "Bà lão mất một giờ để đi dạo quanh hồ hôm qua.", emoji: "🚶‍♀️" },
        { en: "What do you like best about your school?", vi: "Bạn thích điều gì nhất ở trường của mình?", emoji: "🏫" },
        { en: "A private nurse will take care of her when she is ill.", vi: "Một y tá riêng sẽ chăm sóc cô ấy khi cô ấy bị ốm.", emoji: "👩‍⚕️" },
        { en: "You'd better go to the dentist regularly.", vi: "Bạn nên đi khám nha sĩ thường xuyên.", emoji: "🦷" },
        { en: "The sea and rivers are too dirty to swim in.", vi: "Biển và sông quá bẩn để bơi.", emoji: "🌊" },
        { en: "Lucy got dressed quickly and went for work.", vi: "Lucy mặc quần áo nhanh chóng và đi làm.", emoji: "🏃‍♀️" },
        { en: "There is a meeting between 9 am and 2 pm.", vi: "Có một cuộc họp từ 9 giờ sáng đến 2 giờ chiều.", emoji: "🗓️" },
        { en: "How skillfully Van Hau plays football!", vi: "Văn Hậu chơi bóng đá thật điêu luyện!", emoji: "⚽" },
        { en: "Susan was very pleased with the birthday present her father gave her.", vi: "Susan rất hài lòng với món quà sinh nhật mà bố cô đã tặng.", emoji: "🎁" },
        { en: "John told Mary not to touch the wall.", vi: "John bảo Mary không được chạm vào tường.", emoji: "🚫" },
        { en: "I don't like pop music. My sister doesn't like it either.", vi: "Tôi không thích nhạc pop. Chị gái tôi cũng không thích.", emoji: "🎶" },
        { en: "They have just phoned to say that they aren't coming back till Friday night.", vi: "Họ vừa gọi điện để nói rằng họ sẽ không quay lại cho đến tối thứ Sáu.", emoji: "📞" },
        { en: "Bowls, vases, jars, beer mugs and champagne glasses are sold in the glassware store.", vi: "Bát, lọ, bình, cốc bia và ly sâm panh được bán trong cửa hàng đồ thủy tinh.", emoji: "🏺" },
        { en: "If it is kept dry, a seed can still sprout up to forty years after its formation.", vi: "Nếu được giữ khô, một hạt giống vẫn có thể nảy mầm đến bốn mươi năm sau khi hình thành.", emoji: "🌱" },
        { en: "She is very gorgeous in velvet.", vi: "Cô ấy rất lộng lẫy trong bộ đồ nhung.", emoji: "✨" },
        { en: "I have to change the old car tyre. It's flat.", vi: "Tôi phải thay lốp xe cũ. Nó bị xẹp.", emoji: "🚗" },
        { en: "The road to our village should be widened as soon as possible.", vi: "Con đường vào làng của chúng ta nên được mở rộng càng sớm càng tốt.", emoji: "🛣️" }
    ];

    function createTopics(sentences, chunkSize) {
        const shuffled = [...sentences].sort(() => Math.random() - 0.5);
        const topics = {};
        let topicIndex = 1;
        for (let i = 0; i < shuffled.length; i += chunkSize) {
            const chunk = shuffled.slice(i, i + chunkSize);
            topics[`Chủ đề ${topicIndex}`] = chunk;
            topicIndex++;
        }
        return topics;
    }

    const topics = createTopics(allSentences, 50);

    function useSpeechSynthesis() {
        const [isSpeaking, setIsSpeaking] = useState(false);
        const synth = typeof window !== 'undefined' ? window.speechSynthesis : null;

        const speak = useCallback((text, options = {}) => {
            if (!synth) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = options.rate || 0.9;
            utterance.onstart = () => setIsSpeaking(true);
            utterance.onend = () => {
                setIsSpeaking(false);
                if (options.onEnd) options.onEnd();
            };
            utterance.onerror = () => {
                setIsSpeaking(false);
            };

            if (synth.speaking) {
                synth.cancel();
            }
            setTimeout(() => synth.speak(utterance), 100);
        }, [synth]);

        const cancel = useCallback(() => {
            if (synth) {
                synth.cancel();
                setIsSpeaking(false);
            }
        }, [synth]);

        useEffect(() => {
            return () => cancel();
        }, [cancel]);

        return { isSpeaking, speak, cancel };
    }

    function Fireworks() {
        const canvasRef = useRef(null);
        const animationFrameId = useRef(null);

        useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            let width = canvas.width = window.innerWidth;
            let height = canvas.height = window.innerHeight;
            let fireworks = [];
            let particles = [];
            let hue = 120;

            function random(min, max) { return Math.random() * (max - min) + min; }

            class Firework {
                constructor(sx, sy, tx, ty) {
                    this.x = sx; this.y = sy; this.sx = sx; this.sy = sy;
                    this.tx = tx; this.ty = ty;
                    this.distanceToTarget = Math.sqrt(Math.pow(tx - sx, 2) + Math.pow(ty - sy, 2));
                    this.distanceTraveled = 0;
                    this.coordinates = [];
                    this.coordinateCount = 3;
                    while (this.coordinateCount--) {
                        this.coordinates.push([this.x, this.y]);
                    }
                    this.angle = Math.atan2(ty - sy, tx - sx);
                    this.speed = 2;
                    this.acceleration = 1.05;
                    this.brightness = random(50, 70);
                }
                update(index) {
                    this.coordinates.pop();
                    this.coordinates.unshift([this.x, this.y]);
                    this.speed *= this.acceleration;
                    const vx = Math.cos(this.angle) * this.speed;
                    const vy = Math.sin(this.angle) * this.speed;
                    this.distanceTraveled = Math.sqrt(Math.pow(this.x + vx - this.sx, 2) + Math.pow(this.y + vy - this.sy, 2));
                    if (this.distanceTraveled >= this.distanceToTarget) {
                        fireworks.splice(index, 1);
                        for (let i = 0; i < 30; i++) {
                            particles.push(new Particle(this.tx, this.ty));
                        }
                    } else {
                        this.x += vx;
                        this.y += vy;
                    }
                }
                draw() {
                    ctx.beginPath();
                    ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                    ctx.lineTo(this.x, this.y);
                    ctx.strokeStyle = `hsl(${hue}, 100%, ${this.brightness}%)`;
                    ctx.stroke();
                }
            }

            class Particle {
                constructor(x, y) {
                    this.x = x; this.y = y;
                    this.coordinates = [];
                    this.coordinateCount = 5;
                    while (this.coordinateCount--) {
                        this.coordinates.push([this.x, this.y]);
                    }
                    this.angle = random(0, Math.PI * 2);
                    this.speed = random(1, 10);
                    this.friction = 0.95;
                    this.gravity = 1;
                    this.hue = random(hue - 20, hue + 20);
                    this.brightness = random(50, 80);
                    this.alpha = 1;
                    this.decay = random(0.015, 0.03);
                }
                update(index) {
                    this.coordinates.pop();
                    this.coordinates.unshift([this.x, this.y]);
                    this.speed *= this.friction;
                    this.x += Math.cos(this.angle) * this.speed;
                    this.y += Math.sin(this.angle) * this.speed + this.gravity;
                    this.alpha -= this.decay;
                    if (this.alpha <= this.decay) {
                        particles.splice(index, 1);
                    }
                }
                draw() {
                    ctx.beginPath();
                    ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                    ctx.lineTo(this.x, this.y);
                    ctx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
                    ctx.stroke();
                }
            }

            function loop() {
                animationFrameId.current = requestAnimationFrame(loop);
                hue += 0.5;
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, width, height);
                ctx.globalCompositeOperation = 'lighter';
                if (Math.random() < 0.05) {
                    fireworks.push(new Firework(width / 2, height, random(0, width), random(0, height / 2)));
                }
                fireworks.forEach((f, i) => { f.update(i); f.draw(); });
                particles.forEach((p, i) => { p.update(i); p.draw(); });
            }

            const handleResize = () => {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            };

            window.addEventListener('resize', handleResize);
            loop();

            return () => {
                if (animationFrameId.current) {
                    cancelAnimationFrame(animationFrameId.current);
                }
                window.removeEventListener('resize', handleResize);
            };
        }, []);

        return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>;
    }

    function StartScreen({ onStart }) {
        const [playerName, setPlayerName] = useState('');
        const [error, setError] = useState('');

        const handleStart = () => {
            if (playerName.trim()) {
                onStart(playerName.trim());
            } else {
                setError('Vui lòng nhập tên của bạn!');
                setTimeout(() => setError(''), 3000);
            }
        };

        return (
            <div className="w-full flex flex-col items-center gap-4">
                <input
                    type="text"
                    className="w-full max-w-sm p-3 text-center text-lg rounded-xl border-2 border-pink-400 focus:outline-none focus:ring-4 focus:ring-pink-300 transition"
                    placeholder="Nhập tên của bạn..."
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleStart()}
                />
                <button
                    className="w-full max-w-sm bg-green-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-green-600 transform hover:-translate-y-1 transition-all duration-300"
                    onClick={handleStart}
                >
                    Bắt đầu
                </button>
                {error && <div className="text-red-500 font-semibold mt-2">{error}</div>}
            </div>
        );
    }

    function TopicSelectionScreen({ onSelectTopic }) {
        const topicColors = [
            'bg-red-500 hover:bg-red-600',
            'bg-blue-500 hover:bg-blue-600',
            'bg-green-500 hover:bg-green-600',
            'bg-yellow-500 hover:bg-yellow-600',
            'bg-purple-500 hover:bg-purple-600',
            'bg-gray-500 hover:bg-gray-600',
        ];

        return (
            <div className="w-full flex flex-col items-center">
                <h2 className="text-xl md:text-2xl font-semibold text-gray-700 mb-5">Chọn một chủ đề để bắt đầu</h2>
                <div className="w-full max-w-md flex flex-col items-center gap-4">
                    {Object.keys(topics).map((topic, index) => (
                        <button
                            key={topic}
                            className={`w-full text-white font-bold py-4 px-6 text-lg rounded-xl shadow-lg transform hover:-translate-y-1 transition-all duration-300 ${topicColors[index % topicColors.length]}`}
                            onClick={() => onSelectTopic(topic)}
                        >
                            {`${topic} (${topics[topic].length} câu)`}
                        </button>
                    ))}
                </div>
            </div>
        );
    }

    function ReviewErrorsScreen({ errors, onSelectTopic }) {
        const renderDiff = (correct, user) => {
            const diff = [];
            const maxLength = Math.max(correct.length, user.length);
            for (let i = 0; i < maxLength; i++) {
                if (correct[i] !== user[i]) {
                    diff.push(<span key={i} className="text-red-600 font-bold underline bg-red-100">{user[i] || ''}</span>);
                } else {
                    diff.push(<span key={i}>{user[i]}</span>);
                }
            }
            return diff;
        };

        return (
            <div className="w-full flex flex-col items-center">
                <h2 className="text-xl md:text-2xl font-semibold text-gray-700 mb-5">Xem lại các câu trả lời sai</h2>
                <ul className="w-full list-none p-0 max-h-96 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50">
                    {errors.map((error, index) => (
                        <li key={index} className="p-4 border-b border-gray-200 text-left">
                            <div className="font-bold text-sm text-gray-600">Đáp án đúng:</div>
                            <p className="text-green-600 break-words">{error.correctAnswer}</p>
                            <div className="font-bold text-sm text-gray-600 mt-2">Câu trả lời của bạn:</div>
                            <p className="text-red-500 break-words">{renderDiff(error.correctAnswer, error.userAnswer)}</p>
                        </li>
                    ))}
                </ul>
                <button
                    className="mt-6 bg-pink-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-pink-600 transform hover:-translate-y-1 transition-all duration-300"
                    onClick={onSelectTopic}
                >
                    Chọn chủ đề khác
                </button>
            </div>
        );
    }

    function CongratsScreen({ score, total, correctCount, playerName, topic, errors, onPlayAgain, onSelectTopic, onReviewErrors }) {
        return (
            <div className="w-full flex flex-col items-center gap-4">
                <Fireworks />
                <div className="text-green-600 font-bold text-2xl leading-tight">
                    Chúc mừng, <strong>{playerName}</strong>!
                </div>
                <div className="text-lg text-gray-700 text-center">
                    Bạn đã đạt {score} điểm, với {correctCount}/{total} câu trả lời đúng trong "{topic}".
                </div>
                {errors.length > 0 && (
                    <button
                        className="w-full max-w-sm bg-yellow-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-yellow-600 transform hover:-translate-y-1 transition-all duration-300"
                        onClick={onReviewErrors}
                    >
                        Xem lại {errors.length} lỗi sai
                    </button>
                )}
                <button
                    className="w-full max-w-sm bg-green-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-green-600 transform hover:-translate-y-1 transition-all duration-300"
                    onClick={onPlayAgain}
                >
                    Chơi lại chủ đề này
                </button>
                <button
                    className="w-full max-w-sm bg-pink-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-pink-700 transform hover:-translate-y-1 transition-all duration-300"
                    onClick={onSelectTopic}
                >
                    Chọn chủ đề khác
                </button>
            </div>
        );
    }

    function GameScreen({ sentences, onGameEnd, onBackToTopics, topicName }) {
        const [currentIndex, setCurrentIndex] = useState(0);
        const [score, setScore] = useState(0);
        const [completed, setCompleted] = useState(0);
        const [correctCount, setCorrectCount] = useState(0);
        const [mistakeCount, setMistakeCount] = useState(0);
        const [userAnswer, setUserAnswer] = useState('');
        const [message, setMessage] = useState('');
        const [messageColor, setMessageColor] = useState('text-red-500');
        const [isCorrect, setIsCorrect] = useState(null);
        const [isLocked, setIsLocked] = useState(false);
        const [errors, setErrors] = useState([]);
        const [isShaking, setIsShaking] = useState(false);
        const [isHintVisible, setIsHintVisible] = useState(false);

        const { isSpeaking, speak, cancel } = useSpeechSynthesis();
        const inputRef = useRef(null);
        const nextSentenceTimeoutRef = useRef(null);
        
        const normalizeAnswer = (str) => {
          return str.trim().replace(/[\u2018\u2019\u201A\u201B\u2032\u2035`“”]/g, "'").replace(/[“”]/g, '"');
        };

        const currentSentence = sentences[currentIndex];

        const startNewSentence = useCallback((index) => {
            cancel();
            if (nextSentenceTimeoutRef.current) clearTimeout(nextSentenceTimeoutRef.current);

            if (index >= sentences.length) {
                onGameEnd({ score, completed, correctCount, errors });
                return;
            }
            
            setCurrentIndex(index);
            setUserAnswer('');
            setMistakeCount(0);
            setMessage('');
            setIsCorrect(null);
            setIsLocked(false);
            inputRef.current?.focus();
            
            const sentenceToSpeak = sentences[index].en;
            speak(sentenceToSpeak);
        }, [sentences, onGameEnd, score, completed, correctCount, errors, cancel, speak]);
        
        useEffect(() => {
            startNewSentence(0);
            return () => {
                cancel();
                if (nextSentenceTimeoutRef.current) clearTimeout(nextSentenceTimeoutRef.current);
            };
        }, [sentences]);

        const handleCheckAnswer = () => {
            if (isLocked) return;
            
            const correctAnswer = currentSentence.en;

            if (normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer)) {
                setIsCorrect(true);
                setIsLocked(true);
                setMessage('Chính xác! +10 điểm.');
                setMessageColor('text-green-600');
                setScore(prev => prev + 10);
                setCorrectCount(prev => prev + 1);
                setCompleted(prev => prev + 1);
                cancel();
                speak(correctAnswer, { onEnd: () => {
                    nextSentenceTimeoutRef.current = setTimeout(() => startNewSentence(currentIndex + 1), 2000);
                }});
            } else {
                const newMistakeCount = mistakeCount + 1;
                setMistakeCount(newMistakeCount);
                setIsCorrect(false);
                setIsShaking(true);
                setTimeout(() => setIsShaking(false), 500);
                
                if (newMistakeCount >= 3) {
                    setIsLocked(true);
                    setMessage(`Bạn đã sai 3 lần. Đáp án là: "${correctAnswer}"`);
                    setErrors(prev => [...prev, { correctAnswer, userAnswer: userAnswer.trim() }]);
                    setCompleted(prev => prev + 1);
                    cancel();
                    nextSentenceTimeoutRef.current = setTimeout(() => startNewSentence(currentIndex + 1), 3500);
                } else {
                    setMessage(`Sai rồi! (Số lần sai: ${newMistakeCount}/3)`);
                    setTimeout(() => setIsCorrect(null), 500);
                }
            }
        };
        
        const handleListenAgain = () => {
            if (!isSpeaking) {
                speak(currentSentence.en);
            }
        };
        
        const showHint = () => setIsHintVisible(true);
        const hideHint = () => setIsHintVisible(false);

        if (!currentSentence) return <div className="text-lg">Đang tải...</div>;

        const inputClasses = `w-full p-4 text-center text-lg md:text-2xl rounded-xl border-4 transition-all duration-300 focus:outline-none focus:ring-4 ${
            isCorrect === true ? 'border-green-500 bg-green-50 focus:ring-green-500/30' :
            isCorrect === false ? 'border-red-500 bg-red-50 focus:ring-red-500/30' :
            'border-pink-500 focus:ring-pink-500/30'
        } ${isShaking ? 'animate-shake' : ''}`;

        return (
            <div className="w-full flex flex-col items-center">
                <h2 className="text-xl md:text-2xl font-semibold text-gray-700 mb-2">Chủ đề: {topicName}</h2>
                <div className="flex items-center justify-center gap-3 text-lg md:text-2xl italic text-pink-700 my-4 flex-wrap">
                    <span>&ldquo;{currentSentence.vi}&rdquo;</span>
                    <span className="text-3xl">{currentSentence.emoji}</span>
                </div>
                <div className="relative w-full my-6">
                    <input
                        ref={inputRef}
                        type="text"
                        placeholder="Nhập câu bạn nghe được..."
                        autoComplete="off"
                        autoCorrect="off"
                        autoCapitalize="off"
                        spellCheck="false"
                        value={userAnswer}
                        onChange={(e) => setUserAnswer(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleCheckAnswer()}
                        disabled={isLocked}
                        className={inputClasses}
                    />
                    {isHintVisible && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white p-4 rounded-lg text-lg font-semibold pointer-events-none z-10 w-max max-w-[90%]">
                            {currentSentence.en}
                        </div>
                    )}
                </div>
                <div className={`font-bold text-lg min-h-[28px] ${messageColor}`}>{message}</div>
                <div className="flex flex-wrap justify-center gap-4 mt-4">
                    <button className="btn-primary bg-pink-500 hover:bg-pink-600" onClick={handleListenAgain} disabled={isSpeaking || isLocked}>Nghe lại</button>
                    <button className="btn-primary bg-green-500 hover:bg-green-600" onClick={handleCheckAnswer} disabled={isLocked}>Kiểm tra</button>
                    <button 
                        className="btn-primary bg-yellow-500 hover:bg-yellow-600 text-gray-800"
                        disabled={isLocked}
                        onMouseDown={showHint}
                        onMouseUp={hideHint}
                        onMouseLeave={hideHint}
                        onTouchStart={(e) => { e.preventDefault(); showHint(); }}
                        onTouchEnd={hideHint}
                    >
                        Gợi ý
                    </button>
                    <button className="btn-primary bg-gray-500 hover:bg-gray-600" onClick={onBackToTopics}>Chủ đề khác</button>
                </div>
                <div className="mt-5 text-lg font-semibold text-pink-800">Điểm: {score} | Hoàn thành: {completed}/{sentences.length}</div>
            </div>
        );
    }

    function App() {
        const [gameState, setGameState] = useState(GameState.START);
        const [playerName, setPlayerName] = useState('');
        const [currentTopic, setCurrentTopic] = useState(null);
        const [gameResult, setGameResult] = useState({ score: 0, total: 0, correctCount: 0, errors: [] });
        
        const { cancel: cancelSpeech } = useSpeechSynthesis();

        const handleStart = (name) => {
            setPlayerName(name);
            setGameState(GameState.TOPIC_SELECTION);
        };

        const handleSelectTopic = (topic) => {
            setCurrentTopic(topic);
            setGameState(GameState.GAME);
        };
        
        const handleBackToTopics = () => {
            cancelSpeech();
            setGameState(GameState.TOPIC_SELECTION);
        };

        const handleGameEnd = (result) => {
            if (currentTopic) {
                setGameResult({
                    score: result.score, 
                    total: topics[currentTopic].length,
                    correctCount: result.correctCount,
                    errors: result.errors
                });
                setGameState(GameState.CONGRATS);
            }
        };
        
        const handlePlayAgain = () => {
            setGameState(GameState.GAME);
        };
        
        const handleReviewErrors = () => {
            setGameState(GameState.REVIEW_ERRORS);
        };

        const renderScreen = () => {
            switch (gameState) {
                case GameState.START:
                    return <StartScreen onStart={handleStart} />;
                case GameState.TOPIC_SELECTION:
                    return <TopicSelectionScreen onSelectTopic={handleSelectTopic} />;
                case GameState.GAME:
                    if (currentTopic) {
                        return <GameScreen 
                                    sentences={topics[currentTopic]}
                                    topicName={currentTopic} 
                                    onGameEnd={handleGameEnd} 
                                    onBackToTopics={handleBackToTopics} 
                                />;
                    }
                    return null;
                case GameState.CONGRATS:
                    if (currentTopic) {
                        return <CongratsScreen 
                                    {...gameResult} 
                                    playerName={playerName} 
                                    topic={currentTopic}
                                    onPlayAgain={handlePlayAgain}
                                    onSelectTopic={handleBackToTopics}
                                    onReviewErrors={handleReviewErrors}
                                />;
                    }
                    return null;
                case GameState.REVIEW_ERRORS:
                    return <ReviewErrorsScreen 
                                errors={gameResult.errors} 
                                onSelectTopic={handleBackToTopics}
                           />
                default:
                    return <StartScreen onStart={handleStart} />;
            }
        };

        return (
            <main className="bg-gradient-to-br from-pink-100 to-purple-200 min-h-screen w-full flex items-center justify-center p-4">
                <div className="bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl p-6 md:p-8 text-center max-w-4xl w-full">
                    <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold text-pink-500 mb-1 tracking-wide">Nghe và Viết Chính Tả</h1>
                    {renderScreen()}
                </div>
            </main>
        );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
